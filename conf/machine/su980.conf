#@TYPE: Machine
#@NAME: Golden Media HyperCube
#@DESCRIPTION: Machine configuration for the su980

MACHINE_ESSENTIAL_EXTRA_RDEPENDS += "\
	${MACHINE}-dvb-modules \
	${MACHINE}-shutdown \
"

EXTRA_IMAGEDEPENDS += "\
	${MACHINE}-ca-test \
	${MACHINE}-play-test \
	${MACHINE}-uboot-tools \
	${MACHINE}-user-libs \
	${MACHINE}-extra-modules \
	"

MACHINE_EXTRA_RDEPENDS = "\
	${MACHINE}-ca-test \
	${MACHINE}-play-test \
	${MACHINE}-uboot-tools \
	${MACHINE}-user-libs \
	"

module_autoload_nls-iso8859-1 = "nls-iso8859-1"
module_autoload_nls-iso8859-15 = "nls-iso8859-15"
module_autoload_nls-cp437 = "nls-cp437"
module_autoload_nls-cp850 = "nls-cp850"
module_autoload_exportfs = "exportfs"
module_autoload_xfs = "xfs"
module_autoload_iso9660 = "iso9660"
module_autoload_udf = "udf"
module_autoload_cdfs = "cdfs"
module_autoload_ntfs = "ntfs"

DVBMEDIASINK_CONFIG = "--with-dts --with-limited-mpeg4v2 --with-eac3 --with-wma --with-wmv --with-pcm"

IMAGE_FSTYPES ?= "jffs2"

KERNEL_EXTRA_CMD = "--disable-compressor=lzo "

EXTRA_IMAGECMD_jffs2 = " --eraseblock=0x20000 -n -l "

UPDATE_DIR ?= "e2"

IMAGE_CMD_jffs2_prepend = " \
        mkdir -p ${DEPLOY_DIR_IMAGE}/${MACHINE}/${UPDATE_DIR}; \
	mkfs.jffs2 \
		--root=${IMAGE_ROOTFS} \
		--faketime \
		${KERNEL_EXTRA_CMD} \
		--compression-mode=size \
		--output=${DEPLOY_DIR_IMAGE}/${MACHINE}/${UPDATE_DIR}/e2-rootfs.jffs2 \
		${EXTRA_IMAGECMD}; \
	"

# TODO: this needs fixing...
IMAGE_CMD_jffs2_append = " \
	cp ${DEPLOY_DIR_IMAGE}/vmlinux-${MACHINE}.bin > ${DEPLOY_DIR_IMAGE}/e2-kernel-oe.bin; \
	wget -nc -P ${DEPLOY_DIR_IMAGE}/ https://github.com/OpenCube/hypercube-su980/raw/master/meta-openpli/recipes-bsp/su980/e2-kernel.bin; \
	wget -nc -P ${DEPLOY_DIR_IMAGE}/ https://github.com/OpenCube/hypercube-su980/raw/master/meta-openpli/recipes-bsp/su980/boot.bin; \
	wget -nc -P ${DEPLOY_DIR_IMAGE}/ https://github.com/OpenCube/hypercube-su980/raw/master/meta-openpli/recipes-bsp/su980/loader.bin; \
	wget -nc -P ${DEPLOY_DIR_IMAGE}/ https://github.com/OpenCube/hypercube-su980/raw/master/meta-openpli/recipes-bsp/su980/upgrade.scr; \
        cp ${DEPLOY_DIR_IMAGE}/e2-kernel.bin ${DEPLOY_DIR_IMAGE}/${MACHINE}/${UPDATE_DIR}/; \
        cp ${DEPLOY_DIR_IMAGE}/boot.bin ${DEPLOY_DIR_IMAGE}/${MACHINE}/; \
        cp ${DEPLOY_DIR_IMAGE}/loader.bin ${DEPLOY_DIR_IMAGE}/${MACHINE}/; \
        cp ${DEPLOY_DIR_IMAGE}/upgrade.scr ${DEPLOY_DIR_IMAGE}/${MACHINE}/; \
        cd ${DEPLOY_DIR_IMAGE}; \
        zip -r ${IMAGE_NAME}_usb.zip ${MACHINE}/*; \
	rm -f ${DEPLOY_DIR_IMAGE}/*.jffs2; \
	rm -Rf ${MACHINE}; \
        "

MACHINE_FEATURES += "alsa 32bpp hdtv usbhost wifi 3dtv ci wifiusblegacy legacykernel"

require conf/machine/include/tune-su980.inc
include conf/machine/include/autoload-usbserial.inc

PREFERRED_PROVIDER_virtual/kernel ?= "linux-${MACHINE}"
# PREFERRED_VERSION_linux-libc-headers = "2.6.34"
# PREFERRED_VERSION_wpa-supplicant = "0.5.8"
# PREFERRED_VERSION_rtl8192cu = "3.3.0"
# PREFERRED_VERSION_usbmodeswitch = "1.2.7"

# MACHINE_KERNEL_PR = "${GMVERSION}.${GMREVISION}"
